{% extends "base.html" %}

{% block title %}Insights - AI Habit Coach{% endblock %}

{% block content %}
<div class="header">
    <h1>üìä Insights</h1>
</div>

{% if not has_models %}
<div class="card">
    <div style="text-align: center; padding: 20px;">
        <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h3 style="color: #ff3b30;">Models Not Trained Yet</h3>
        <p style="color: #8e8e93; margin: 15px 0;">
            Train the ML models to get AI recommendations.
        </p>
        <p style="color: #8e8e93;">
            Run: <code style="background: #2c2c2e; padding: 4px 8px; border: none; border-radius: 6px; font-size: 14px;">python3 main.py train {{ profile.name.lower().replace(' ', '_') }}</code>
        </p>
    </div>
</div>
{% else %}

<div class="card">
    <h3>üò¥ Sleep Quality Impact</h3>
    <p style="color: #8e8e93; margin-bottom: 20px;">How your sleep affects habit completion</p>
    
    <!-- Sleep correlation chart -->
    <div style="position: relative; height: 220px; margin: 20px 0;">
        <canvas id="sleepCorrelationChart"></canvas>
    </div>
    
    <!-- Today's prediction based on sleep -->
    <div style="padding: 14px; background: #2c2c2e; border-radius: 10px; margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="color: #8e8e93; font-size: 13px;">Today's Sleep Quality</div>
                <div style="color: #ffffff; font-weight: 600; font-size: 20px; margin-top: 4px;">{{ "%.1f"|format(today_health.sleep_quality) }}/10</div>
            </div>
            <div style="text-align: right;">
                <div style="color: #8e8e93; font-size: 13px;">Expected Success</div>
                <div style="color: {% if sleep_success_rate > 0.5 %}#34c759{% elif sleep_success_rate > 0.3 %}#ff9500{% else %}#ff3b30{% endif %}; font-weight: 600; font-size: 20px; margin-top: 4px;">
                    {{ (sleep_success_rate * 100)|int }}%
                </div>
            </div>
        </div>
        <div style="margin-top: 12px; padding-top: 12px; border-top: 0.5px solid #3a3a3c; color: #8e8e93; font-size: 13px;">
            {{ sleep_insight }}
        </div>
    </div>
</div>

<div class="card">
    <h3>üìä When You Complete Habits</h3>
    <p style="color: #8e8e93; margin-bottom: 20px;">Based on your actual completion history</p>
    
    <!-- Hour by hour chart -->
    <div style="position: relative; height: 200px; margin: 20px 0;">
        <canvas id="completionChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Sleep correlation chart
const sleepData = {{ sleep_correlation_data|tojson }};
const ctxSleep = document.getElementById('sleepCorrelationChart').getContext('2d');

new Chart(ctxSleep, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Completed',
            data: sleepData.completions.map(d => ({x: d.sleep, y: 1})),
            backgroundColor: '#34c759',
            pointRadius: 6,
            pointHoverRadius: 8
        }, {
            label: 'Skipped',
            data: sleepData.failures.map(d => ({x: d.sleep, y: 0})),
            backgroundColor: '#ff3b30',
            pointRadius: 6,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    color: '#8e8e93',
                    usePointStyle: true,
                    padding: 15
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `Sleep: ${context.parsed.x.toFixed(1)}/10`;
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Sleep Quality',
                    color: '#8e8e93'
                },
                min: 0,
                max: 10,
                ticks: {
                    color: '#8e8e93'
                },
                grid: {
                    color: 'rgba(58, 58, 60, 0.3)'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Outcome',
                    color: '#8e8e93'
                },
                min: -0.2,
                max: 1.2,
                ticks: {
                    stepSize: 1,
                    color: '#8e8e93',
                    callback: function(value) {
                        return value === 1 ? 'Complete' : value === 0 ? 'Skip' : '';
                    }
                },
                grid: {
                    color: 'rgba(58, 58, 60, 0.3)'
                }
            }
        }
    }
});

// Hourly completions chart
const hourlyData = {{ hourly_completions|tojson }};
const labels = Array.from({length: 24}, (_, i) => i);
const counts = labels.map(hour => {
    const found = hourlyData.find(item => item[0] === hour);
    return found ? found[1] : 0;
});

// Create chart
const ctx = document.getElementById('completionChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels.map(h => h.toString().padStart(2, '0') + ':00'),
        datasets: [{
            label: 'Completions',
            data: counts,
            borderColor: '#007aff',
            backgroundColor: 'rgba(0, 122, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#007aff',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    color: '#8e8e93'
                },
                grid: {
                    color: 'rgba(58, 58, 60, 0.3)'
                }
            },
            x: {
                ticks: {
                    color: '#8e8e93',
                    maxRotation: 45,
                    minRotation: 45,
                    font: {
                        size: 10
                    }
                },
                grid: {
                    color: 'rgba(58, 58, 60, 0.3)'
                }
            }
        }
    }
});
</script>

<div class="card">
    <h3>üí° Key Insights</h3>
    
    <!-- Consistency Score -->
    <div class="health-indicator">
        <span class="health-label">Consistency Rate</span>
        <span class="health-value">{{ (stats.completion_rate * 100)|int }}%</span>
    </div>
    
    <!-- Current Momentum -->
    <div class="health-indicator">
        <span class="health-label">Current Streak</span>
        <span class="health-value" style="{% if stats.current_streak >= 7 %}color: #34c759;{% elif stats.current_streak >= 3 %}color: #007aff;{% else %}color: #8e8e93;{% endif %}">
            üî• {{ stats.current_streak }} days
        </span>
    </div>
    
    <!-- Best Streak -->
    <div class="health-indicator">
        <span class="health-label">Best Streak</span>
        <span class="health-value">üèÜ {{ stats.longest_streak }} days</span>
    </div>
    
    <!-- Total Completions -->
    <div class="health-indicator">
        <span class="health-label">Total Completions</span>
        <span class="health-value">{{ stats.total_completions }} days</span>
    </div>
    
    <!-- Alerts -->
    {% if stats.current_streak >= 7 %}
    <div class="alert alert-success" style="margin-top: 16px;">
        <strong>üî• On Fire!</strong> {{ stats.current_streak }}-day streak! Keep it going!
    </div>
    {% elif stats.days_since_last > 2 %}
    <div class="alert alert-warning" style="margin-top: 16px;">
        <strong>‚ö†Ô∏è</strong> {{ stats.days_since_last }} days since last completion. Time to get back on track!
    </div>
    {% elif stats.current_streak >= 3 %}
    <div class="alert alert-info" style="margin-top: 16px;">
        <strong>üí™</strong> {{ stats.current_streak }}-day streak building! One day at a time.
    </div>
    {% endif %}
</div>


{% endif %}

<div style="padding: 0 16px;">
    <a href="/" class="btn btn-primary">‚Üê Back to Dashboard</a>
</div>
{% endblock %}

