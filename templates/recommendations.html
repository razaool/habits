{% extends "base.html" %}

{% block title %}Insights - AI Habit Coach{% endblock %}

{% block content %}
<div class="header">
    <h1>📊 Insights</h1>
</div>

{% if not has_models %}
<div class="card">
    <div style="text-align: center; padding: 20px;">
        <div style="font-size: 48px; margin-bottom: 10px;">⚠️</div>
        <h3 style="color: #ff3b30;">Models Not Trained Yet</h3>
        <p style="color: #8e8e93; margin: 15px 0;">
            Train the ML models to get AI recommendations.
        </p>
        <p style="color: #8e8e93;">
            Run: <code style="background: #2c2c2e; padding: 4px 8px; border: none; border-radius: 6px; font-size: 14px;">python3 main.py train {{ profile.name.lower().replace(' ', '_') }}</code>
        </p>
    </div>
</div>
{% else %}

<div class="card">
    <h3>📊 When You Complete Habits</h3>
    <p style="color: #8e8e93; margin-bottom: 20px;">Based on your actual completion history</p>
    
    <!-- Hour by hour chart -->
    <div style="position: relative; height: 200px; margin: 20px 0;">
        <canvas id="completionChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Prepare data for chart
const hourlyData = {{ hourly_completions|tojson }};
const labels = Array.from({length: 24}, (_, i) => i);
const counts = labels.map(hour => {
    const found = hourlyData.find(item => item[0] === hour);
    return found ? found[1] : 0;
});

// Create chart
const ctx = document.getElementById('completionChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels.map(h => h.toString().padStart(2, '0') + ':00'),
        datasets: [{
            label: 'Completions',
            data: counts,
            borderColor: '#007aff',
            backgroundColor: 'rgba(0, 122, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#007aff',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    color: '#8e8e93'
                },
                grid: {
                    color: 'rgba(58, 58, 60, 0.3)'
                }
            },
            x: {
                ticks: {
                    color: '#8e8e93',
                    maxRotation: 45,
                    minRotation: 45,
                    font: {
                        size: 10
                    }
                },
                grid: {
                    color: 'rgba(58, 58, 60, 0.3)'
                }
            }
        }
    }
});
</script>

<div class="card">
    <h3>💡 Key Insights</h3>
    
    <!-- Consistency Score -->
    <div class="health-indicator">
        <span class="health-label">Consistency Rate</span>
        <span class="health-value">{{ (stats.completion_rate * 100)|int }}%</span>
    </div>
    
    <!-- Current Momentum -->
    <div class="health-indicator">
        <span class="health-label">Current Streak</span>
        <span class="health-value" style="{% if stats.current_streak >= 7 %}color: #34c759;{% elif stats.current_streak >= 3 %}color: #007aff;{% else %}color: #8e8e93;{% endif %}">
            🔥 {{ stats.current_streak }} days
        </span>
    </div>
    
    <!-- Best Streak -->
    <div class="health-indicator">
        <span class="health-label">Best Streak</span>
        <span class="health-value">🏆 {{ stats.longest_streak }} days</span>
    </div>
    
    <!-- Total Completions -->
    <div class="health-indicator">
        <span class="health-label">Total Completions</span>
        <span class="health-value">{{ stats.total_completions }} days</span>
    </div>
    
    <!-- Alerts -->
    {% if stats.current_streak >= 7 %}
    <div class="alert alert-success" style="margin-top: 16px;">
        <strong>🔥 On Fire!</strong> {{ stats.current_streak }}-day streak! Keep it going!
    </div>
    {% elif stats.days_since_last > 2 %}
    <div class="alert alert-warning" style="margin-top: 16px;">
        <strong>⚠️</strong> {{ stats.days_since_last }} days since last completion. Time to get back on track!
    </div>
    {% elif stats.current_streak >= 3 %}
    <div class="alert alert-info" style="margin-top: 16px;">
        <strong>💪</strong> {{ stats.current_streak }}-day streak building! One day at a time.
    </div>
    {% endif %}
</div>


{% endif %}

<div style="padding: 0 16px;">
    <a href="/" class="btn btn-primary">← Back to Dashboard</a>
</div>
{% endblock %}

